{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <form method="post" id="loginForm" class="form-signin">
        {% csrf_token %}
        <div class="form-group mb-3">
            <label for="id_username">Username</label>
            <input type="text" id="id_username" name="username" class="form-control" required autofocus>
        </div>
        <div class="form-group mb-3">
            <label for="id_password">Password</label>
            <input type="password" id="id_password" name="password" class="form-control" required>
        </div>
        <button class="btn btn-lg btn-primary btn-block" type="submit">Login</button>
    </form>
</div>

<script src="{% static 'js/getCookie.js' %}"></script>
<script>
    // Met à jour la navbar en fonction de l'état d'authentification
    function updateNavbar(username) {
        if (username) {
            $('.navbar-nav').html(`
                <li class="nav-item">
                    <span class="nav-link">Welcome, ${username}</span>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'room_list' %}">Chat Room List</a>
                </li>
                <li class="nav-item">
                    <button id="navbarLogoutButton" class="btn btn-link nav-link" type="button">Logout</button>
                </li>
            `);
            addLogoutEvent("#navbarLogoutButton"); // Ajoute l'événement de déconnexion
        } else {
            $('.navbar-nav').html(`
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'account_view' %}">Login</a>
                </li>
            `);
        }
    }

    // Met à jour le token CSRF dans le formulaire
    function updateCSRFToken() {
        const csrftoken = getCookie('csrftoken');
        $('input[name=csrfmiddlewaretoken]').val(csrftoken); // Met à jour le champ caché
    }

    // Ajoute l'événement de login au formulaire
    function addLoginEvent() {
        $("#loginForm").submit(function(e) {
            e.preventDefault(); // Empêche l'envoi classique du formulaire
            $.ajax({
                type: "POST",
                url: "/account/",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    username: $('#id_username').val(),
                    password: $('#id_password').val(),
                },
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                },
                success: function(data) {
                    if (data.logged_in) {
                        updateNavbar(data.username); // Mise à jour de la navbar
                        $('.container').html(`
                            <div class="text-center">
                                <p>Logged in as ${data.username}</p>
                                <button id="logoutButton" class="btn btn-primary" type="button">Logout</button>
                            </div>
                        `);
                        addLogoutEvent("#logoutButton"); // Ajoute l'événement de déconnexion
                    } else {
                        alert("Login failed: " + JSON.stringify(data.errors));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error during login:', error);
                    alert('Login failed. Please try again.'); // Affiche une alerte en cas d'erreur
                }
            });
        });
    }

    // Ajoute l'événement de déconnexion au bouton logout
    function addLogoutEvent(buttonSelector) {
        $(buttonSelector).click(function() {
            const csrftoken = getCookie('csrftoken'); // Récupération du cookie CSRF

            console.log("Logout button clicked. Sending logout request...");

            $.ajax({
                type: "POST",
                url: "/account/",
                data: {
                    csrfmiddlewaretoken: csrftoken, // Envoi du token CSRF
                    logout: true // Indique que c'est une requête de déconnexion
                },
                headers: {
                    "X-CSRFToken": csrftoken
                },
                success: function(data) {
                    if (data.logged_out) {
                        console.log("Successfully logged out. Updating UI...");
                        updateNavbar(null); // Mise à jour de la navbar
                        displayLoginForm(); // Affichage du formulaire de connexion
                    } else {
                        console.error("Logout failed or no data received.");
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error during logout:', error);
                    alert('Logout failed. Please try again.'); // Affiche une alerte en cas d'erreur
                }
            });
        });
    }

    // Affiche le formulaire de login
    function displayLoginForm() {
        $('.container').html(`
            <form method="post" id="loginForm" class="form-signin">
                {% csrf_token %}
                <div class="form-group mb-3">
                    <label for="id_username">Username</label>
                    <input type="text" id="id_username" name="username" class="form-control" required autofocus>
                </div>
                <div class="form-group mb-3">
                    <label for="id_password">Password</label>
                    <input type="password" id="id_password" name="password" class="form-control" required>
                </div>
                <button class="btn btn-lg btn-primary btn-block" type="submit">Login</button>
            </form>
        `);
        updateCSRFToken(); // Met à jour le token CSRF dans le nouveau formulaire
        addLoginEvent(); // Réinitialise l'événement du formulaire
    }

    // Initialise les événements de login lors du chargement de la page
    addLoginEvent();
</script>
{% endblock %}