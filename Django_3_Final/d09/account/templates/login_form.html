{% extends 'base.html' %}

{% block title %}Logged In{% endblock %}

{% block content %}
	<div class="container mt-5">
		<form method="post" id="loginForm" class="form-signin">
			{% csrf_token %}
			<div class="form-group mb-3">
				<label for="id_username">Username</label>
				<input type="text" id="id_username" name="username" class="form-control" required autofocus>
			</div>
			<div class="form-group mb-3">
				<label for="id_password">Password</label>
				<input type="password" id="id_password" name="password" class="form-control" required>
			</div>
			<button class="btn btn-lg btn-primary btn-block" type="submit">Login</button>
		</form>
	</div>
	<script>
		$("#loginForm").submit(function(e) {
			e.preventDefault();
			$.ajax({
				type: "POST",
				url: "/account/",
				data: {
					csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
					username: $('#id_username').val(),
					password: $('#id_password').val(),
				},
				headers: {
					"X-CSRFToken": getCookie("csrftoken") // Fonction pour récupérer le cookie csrftoken
				},
				success: function(data) {
					if(data.logged_in) {
						location.reload(); // Reload the page to show the logged-in state
					} else {
						alert("Login failed: " + JSON.stringify(data.errors));
					}
				}
			});
		});

		function getCookie(name) {
			let cookieValue = null;
			if (document.cookie && document.cookie !== '') {
				const cookies = document.cookie.split(';');
				for (let i = 0; i < cookies.length; i++) {
					const cookie = cookies[i].trim();
					if (cookie.substring(0, name.length + 1) === (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}
	</script>
{% endblock %}